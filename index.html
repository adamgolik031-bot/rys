<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Scraper Results Viewer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .controls {
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
      }

      .filter-input {
        padding: 10px 15px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 14px;
        min-width: 200px;
        transition: border-color 0.3s;
      }

      .filter-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .filter-button {
        padding: 10px 20px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.3s;
      }

      .filter-button:hover {
        background: #5a6fd8;
      }

      .pagination-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-left: auto;
        flex-wrap: wrap;
      }

      .pagination-info {
        font-size: 14px;
        color: #666;
        white-space: nowrap;
      }

      .pagination-buttons {
        display: flex;
        gap: 5px;
      }

      .pagination-btn {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .pagination-btn:hover:not(:disabled) {
        background: #f0f0f0;
      }

      .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .pagination-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      .view-mode-toggle {
        display: flex;
        background: #f5f5f5;
        border-radius: 8px;
        overflow: hidden;
      }

      .view-mode-btn {
        padding: 8px 16px;
        border: none;
        background: transparent;
        cursor: pointer;
        transition: all 0.3s;
      }

      .view-mode-btn.active {
        background: #667eea;
        color: white;
      }

      .auto-refresh {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
      }

      .toggle-switch {
        width: 50px;
        height: 25px;
        background: #ccc;
        border-radius: 25px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
      }

      .toggle-switch.active {
        background: #667eea;
      }

      .toggle-switch::after {
        content: "";
        position: absolute;
        width: 21px;
        height: 21px;
        border-radius: 50%;
        background: white;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
      }

      .toggle-switch.active::after {
        transform: translateX(25px);
      }

      .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
      }

      .status-in-progress {
        background: #ffa500;
        animation: pulse 2s infinite;
      }

      .status-completed {
        background: #4caf50;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }

        50% {
          opacity: 0.5;
        }

        100% {
          opacity: 1;
        }
      }

      .results-grid {
        display: grid;
        gap: 20px;
      }

      .results-grid.grid-view {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      }

      .results-grid.list-view {
        grid-template-columns: 1fr;
      }

      .result-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
      }

      .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      }

      .result-card.list-view {
        display: flex;
        flex-direction: row;
      }

      .result-card.list-view .card-thumbnail {
        width: 200px;
        flex-shrink: 0;
      }

      .card-thumbnail {
        position: relative;
        height: 200px;
        background: #f5f5f5;
        overflow: hidden;
      }

      .thumbnail-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .thumbnail-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: #999;
        background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
      }

      .card-overlay {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
      }

      .card-sources-count {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(103, 126, 234, 0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
      }

      .external-link-icon {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
      }

      .card-body {
        padding: 15px;
      }

      .card-title {
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 8px;
        color: #333;
        line-height: 1.3;
      }

      .card-url {
        color: #667eea;
        font-size: 0.9rem;
        margin-bottom: 10px;
        word-break: break-all;
      }

      .sources-list {
        margin-bottom: 10px;
      }

      .source-item {
        background: #f8f9fa;
        padding: 4px 8px;
        margin: 4px 0;
        border-radius: 4px;
        font-size: 0.85rem;
        color: #666;
        word-break: break-all;
      }

      .no-sources {
        color: #999;
        font-style: italic;
        font-size: 0.9rem;
      }

      .timestamp {
        font-size: 0.8rem;
        color: #999;
        border-top: 1px solid #eee;
        padding-top: 8px;
      }

      .loading {
        text-align: center;
        padding: 50px 20px;
        color: white;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .filters {
          flex-direction: column;
          align-items: stretch;
        }

        .filter-input {
          min-width: auto;
          width: 100%;
        }

        .pagination-controls {
          margin-left: 0;
          width: 100%;
          justify-content: center;
        }

        .results-grid.grid-view {
          grid-template-columns: 1fr;
        }

        .result-card.list-view {
          flex-direction: column;
        }

        .result-card.list-view .card-thumbnail {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>🚀 Enhanced Scraper Results Viewer</h1>
        <p>Real-time monitoring with thumbnails, titles, and direct access</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalItems">0</div>
          <div class="stat-label">Total Items</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalPages">0</div>
          <div class="stat-label">Pages Processed</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="currentPage">1</div>
          <div class="stat-label">Current Page</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avgSources">0</div>
          <div class="stat-label">Avg Sources/Item</div>
        </div>
      </div>

      <div class="controls">
        <div class="filters">
          <input
            type="text"
            class="filter-input"
            id="titleFilter"
            placeholder="🔍 Filter by title..."
          />
          <input
            type="text"
            class="filter-input"
            id="urlFilter"
            placeholder="🔗 Filter by URL..."
          />
          <input
            type="number"
            class="filter-input"
            id="minSources"
            placeholder="Min sources"
            style="max-width: 120px"
          />
          <button class="filter-button" onclick="applyFilters()">
            Apply Filters
          </button>
          <button class="filter-button" onclick="clearFilters()">Clear</button>

          <div class="view-mode-toggle">
            <button class="view-mode-btn active" onclick="setViewMode('grid')">
              Grid
            </button>
            <button class="view-mode-btn" onclick="setViewMode('list')">
              List
            </button>
          </div>

          <div class="pagination-controls">
            <div class="pagination-info" id="paginationInfo">
              Showing 0-0 of 0 items
            </div>
            <div class="pagination-buttons">
              <button
                class="pagination-btn"
                id="prevBtn"
                onclick="previousPage()"
              >
                ‹ Prev
              </button>
              <button class="pagination-btn" id="nextBtn" onclick="nextPage()">
                Next ›
              </button>
            </div>
          </div>
        </div>

        <div class="auto-refresh">
          <span>Auto-refresh:</span>
          <div
            class="toggle-switch active"
            id="autoRefreshToggle"
            onclick="toggleAutoRefresh()"
          ></div>
          <span id="refreshStatus">ON</span>
          <span id="statusIndicator">
            <span class="status-indicator status-in-progress"></span>
            <span id="scrapingStatus">Loading...</span>
          </span>
        </div>
      </div>

      <div id="resultsContainer">
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading scraping results...</p>
        </div>
      </div>
    </div>

    <script>
      let allData = [];
      let filteredData = [];
      let autoRefreshInterval = null;
      let isAutoRefresh = true;
      let currentViewMode = "grid";
      let currentOffset = 0;
      let itemsPerPage = 20;
      let totalItems = 0;
      let baseUrl = "https://rys.onrender.com";

      // Start auto-refresh immediately
      startAutoRefresh();

      async function loadDataFromAPI() {
        try {
          const url = `${baseUrl}/api/get?offset=${currentOffset}&limit=${itemsPerPage}`;
          const response = await fetch(url);
          const jsonData = await response.json();
          loadData(jsonData);
        } catch (error) {
          console.error("Error loading data from API:", error);
          setTimeout(loadDataFromAPI, 5000); // Retry after 5 seconds
        }
      }

      function loadData(jsonData) {
        allData = jsonData.items || [];
        filteredData = [...allData];
        totalItems = jsonData.database_stats?.total_items || 0;

        updateStats(jsonData);
        displayResults(filteredData);
        updatePaginationInfo();
        updateScrapingStatus(
          jsonData.database_stats?.database_status || "unknown",
        );
      }

      function updateStats(jsonData) {
        const stats = jsonData.database_stats || {};
        const queryParams = jsonData.query_params || {};

        document.getElementById("totalItems").textContent =
          stats.total_items || 0;
        document.getElementById("totalPages").textContent =
          stats.total_pages || 0;
        document.getElementById("currentPage").textContent =
          Math.floor(currentOffset / itemsPerPage) + 1;

        // Calculate average sources
        const totalSources = allData.reduce(
          (sum, item) => sum + (item.sources?.length || 0),
          0,
        );
        const avgSources =
          allData.length > 0 ? (totalSources / allData.length).toFixed(1) : 0;
        document.getElementById("avgSources").textContent = avgSources;
      }

      function updatePaginationInfo() {
        const start = currentOffset + 1;
        const end = Math.min(currentOffset + itemsPerPage, totalItems);
        const info = `Showing ${start}-${end} of ${totalItems} items`;
        document.getElementById("paginationInfo").textContent = info;

        // Update pagination buttons
        document.getElementById("prevBtn").disabled = currentOffset <= 0;
        document.getElementById("nextBtn").disabled =
          currentOffset + itemsPerPage >= totalItems;
      }

      function updateScrapingStatus(status) {
        const statusElement = document.getElementById("scrapingStatus");
        const indicatorElement = document.querySelector(
          "#statusIndicator .status-indicator",
        );

        if (status === "connected") {
          statusElement.textContent = "Database connected";
          indicatorElement.className = "status-indicator status-completed";
        } else {
          statusElement.textContent = "Status: " + status;
          indicatorElement.className = "status-indicator status-in-progress";
        }
      }

      function displayResults(data) {
        const container = document.getElementById("resultsContainer");

        if (data.length === 0) {
          container.innerHTML = `
          <div class="loading">
            <p>No results found on this page...</p>
          </div>
        `;
          return;
        }

        const html = data
          .map((item) => {
            const sourcesHtml =
              item.sources && item.sources.length > 0
                ? item.sources
                    .slice(0, 3)
                    .map((source) => `<div class="source-item">${source}</div>`)
                    .join("") +
                  (item.sources.length > 3
                    ? `<div class="source-item">... and ${item.sources.length - 3} more sources</div>`
                    : "")
                : '<div class="no-sources">No video sources found</div>';

            const timestamp = new Date(item.timestamp * 1000).toLocaleString();
            const title = item.title || `Element ${item.element_index}`;
            const thumbnailHtml = item.thumbnail
              ? `<img src="${item.thumbnail}" alt="Thumbnail" class="thumbnail-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
              : "";

            return `
            <div class="result-card ${currentViewMode}-view" onclick="openLink('${item.sources}')" data-url="${item.url}" data-title="${title.toLowerCase()}">
              <div class="card-thumbnail">
                ${thumbnailHtml}
                <div class="thumbnail-placeholder" style="${item.thumbnail ? "display: none;" : ""}">
                  🎬
                </div>
                <div class="card-overlay">
                  <div class="card-index">Page ${item.page} - #${item.element_index}</div>
                </div>
                <div class="card-sources-count">
                  📹 ${item.sources?.length || 0} sources
                </div>
                <div class="external-link-icon">🔗</div>
              </div>
              <div class="card-body">
                <div class="card-title">${title}</div>
                <div class="card-url">${item.url}</div>
                <div class="sources-list">
                  ${sourcesHtml}
                </div>
                <div class="timestamp">🕐 ${timestamp}</div>
              </div>
            </div>
          `;
          })
          .join("");

        container.innerHTML = `<div class="results-grid ${currentViewMode}-view">${html}</div>`;
      }

      function nextPage() {
        if (currentOffset + itemsPerPage < totalItems) {
          currentOffset += itemsPerPage;
          loadDataFromAPI();
        }
      }

      function previousPage() {
        if (currentOffset > 0) {
          currentOffset = Math.max(0, currentOffset - itemsPerPage);
          loadDataFromAPI();
        }
      }

      function openLink(url) {
        window.open(url, "_blank");
      }

      function applyFilters() {
        const titleFilter = document
          .getElementById("titleFilter")
          .value.toLowerCase();
        const urlFilter = document
          .getElementById("urlFilter")
          .value.toLowerCase();
        const minSources = document.getElementById("minSources").value;

        filteredData = allData.filter((item) => {
          if (
            titleFilter &&
            !(item.title || "").toLowerCase().includes(titleFilter)
          )
            return false;
          if (urlFilter && !item.url.toLowerCase().includes(urlFilter))
            return false;
          if (minSources && (item.sources?.length || 0) < parseInt(minSources))
            return false;
          return true;
        });

        displayResults(filteredData);
      }

      function clearFilters() {
        document.getElementById("titleFilter").value = "";
        document.getElementById("urlFilter").value = "";
        document.getElementById("minSources").value = "";
        filteredData = [...allData];
        displayResults(filteredData);
      }

      function setViewMode(mode) {
        currentViewMode = mode;

        // Update buttons
        document.querySelectorAll(".view-mode-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        displayResults(filteredData);
      }

      function toggleAutoRefresh() {
        const toggle = document.getElementById("autoRefreshToggle");
        const status = document.getElementById("refreshStatus");

        isAutoRefresh = !isAutoRefresh;

        if (isAutoRefresh) {
          toggle.classList.add("active");
          status.textContent = "ON";
          startAutoRefresh();
        } else {
          toggle.classList.remove("active");
          status.textContent = "OFF";
          stopAutoRefresh();
        }
      }

      function startAutoRefresh() {
        // Load data immediately
        loadDataFromAPI();

        // Set up interval for continuous updates
        autoRefreshInterval = setInterval(() => {
          loadDataFromAPI();
        }, 5000); // Refresh every 5 seconds
      }

      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
      }

      // Real-time search
      document
        .getElementById("titleFilter")
        .addEventListener("input", applyFilters);
      document
        .getElementById("urlFilter")
        .addEventListener("input", applyFilters);

      // Keyboard shortcuts
      document.addEventListener("keydown", function (e) {
        if (e.ctrlKey || e.metaKey) {
          if (e.key === "r") {
            e.preventDefault();
            toggleAutoRefresh();
          }
          if (e.key === "f") {
            e.preventDefault();
            document.getElementById("titleFilter").focus();
          }
        }
        // Page navigation shortcuts
        if (e.key === "ArrowLeft" && e.altKey) {
          e.preventDefault();
          previousPage();
        }
        if (e.key === "ArrowRight" && e.altKey) {
          e.preventDefault();
          nextPage();
        }
      });

      // Handle image load errors
      document.addEventListener(
        "error",
        function (e) {
          if (
            e.target.tagName === "IMG" &&
            e.target.classList.contains("thumbnail-image")
          ) {
            e.target.style.display = "none";
            const placeholder = e.target.nextElementSibling;
            if (
              placeholder &&
              placeholder.classList.contains("thumbnail-placeholder")
            ) {
              placeholder.style.display = "flex";
            }
          }
        },
        true,
      );
    </script>
  </body>
</html>
