<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🚀 Enhanced Scraper Results Viewer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-number {
      font-size: 2.5em;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }

    .stat-label {
      font-size: 0.9em;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .controls {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
    }

    .filters {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 15px;
    }

    .filter-input {
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 25px;
      font-size: 14px;
      flex: 1;
      min-width: 200px;
    }

    .filter-button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.2s ease;
    }

    .filter-button:hover {
      transform: scale(1.05);
    }

    .auto-refresh {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 25px;
      background: #ccc;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: #667eea;
    }

    .toggle-switch::after {
      content: "";
      position: absolute;
      top: 2px;
      left: 2px;
      width: 21px;
      height: 21px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch.active::after {
      transform: translateX(25px);
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-in-progress {
      background: #ffa500;
      animation: pulse 2s infinite;
    }

    .status-completed {
      background: #28a745;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 25px;
    }

    .result-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .result-card:hover {
      transform: translateY(-10px) scale(1.02);
    }

    .card-thumbnail {
      position: relative;
      height: 200px;
      overflow: hidden;
      background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .thumbnail-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .result-card:hover .thumbnail-image {
      transform: scale(1.1);
    }

    .thumbnail-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: white;
      font-size: 3em;
      opacity: 0.7;
    }

    .card-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to bottom,
          rgba(0, 0, 0, 0.7) 0%,
          transparent 50%);
      color: white;
      padding: 15px;
    }

    .card-index {
      position: absolute;
      top: 10px;
      right: 15px;
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
    }

    .card-sources-count {
      position: absolute;
      bottom: 10px;
      left: 15px;
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      backdrop-filter: blur(10px);
    }

    .card-body {
      padding: 20px;
    }

    .card-title {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 1.1em;
      color: #333;
      line-height: 1.4;
      max-height: 2.8em;
      overflow: hidden;
    }

    .card-url {
      font-size: 0.85em;
      color: #666;
      word-break: break-all;
      margin-bottom: 10px;
    }

    .sources-list {
      margin-top: 10px;
    }

    .source-item {
      background: #f8f9ff;
      padding: 8px;
      margin: 5px 0;
      border-radius: 6px;
      border-left: 4px solid #667eea;
      word-break: break-all;
      font-size: 0.8em;
    }

    .no-sources {
      color: #999;
      font-style: italic;
      text-align: center;
      padding: 15px;
    }

    .timestamp {
      color: #666;
      font-size: 0.8em;
      margin-top: 10px;
    }

    .loading {
      text-align: center;
      padding: 50px;
      color: #666;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .external-link-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2em;
      color: white;
      opacity: 0;
      transition: opacity 0.3s ease;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 50%;
      backdrop-filter: blur(10px);
    }

    .result-card:hover .external-link-icon {
      opacity: 1;
    }

    .view-mode-toggle {
      margin-left: auto;
      display: flex;
      gap: 10px;
    }

    .view-mode-btn {
      padding: 8px 15px;
      border: 2px solid #667eea;
      background: transparent;
      color: #667eea;
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .view-mode-btn.active {
      background: #667eea;
      color: white;
    }

    .results-grid.list-view {
      grid-template-columns: 1fr;
    }

    .result-card.list-view {
      display: flex;
      height: 120px;
    }

    .result-card.list-view .card-thumbnail {
      width: 200px;
      height: 120px;
      flex-shrink: 0;
    }

    .result-card.list-view .card-body {
      flex: 1;
      padding: 15px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>🚀 Enhanced Scraper Results Viewer</h1>
      <p>Real-time monitoring with thumbnails, titles, and direct access</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalItems">0</div>
        <div class="stat-label">Total Items</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalPages">0</div>
        <div class="stat-label">Pages Processed</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="cpuCores">0</div>
        <div class="stat-label">CPU Cores Used</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgSources">0</div>
        <div class="stat-label">Avg Sources/Item</div>
      </div>
    </div>

    <div class="controls">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <div class="filters">
        <input type="text" class="filter-input" id="titleFilter" placeholder="🔍 Filter by title..." />
        <input type="text" class="filter-input" id="urlFilter" placeholder="🔗 Filter by URL..." />
        <input type="number" class="filter-input" id="pageFilter" placeholder="📄 Page number..."
          style="max-width: 150px" />
        <input type="number" class="filter-input" id="minSources" placeholder="Min sources" style="max-width: 120px" />
        <button class="filter-button" onclick="applyFilters()">
          Apply Filters
        </button>
        <button class="filter-button" onclick="clearFilters()">Clear</button>

        <div class="view-mode-toggle">
          <button class="view-mode-btn active" onclick="setViewMode('grid')">
            Grid
          </button>
          <button class="view-mode-btn" onclick="setViewMode('list')">
            List
          </button>
        </div>
      </div>

      <div class="auto-refresh">
        <span>Auto-refresh:</span>
        <div class="toggle-switch active" id="autoRefreshToggle" onclick="toggleAutoRefresh()"></div>
        <span id="refreshStatus">ON</span>
        <span id="statusIndicator">
          <span class="status-indicator status-in-progress"></span>
          <span id="scrapingStatus">Loading...</span>
        </span>
      </div>
    </div>

    <div id="resultsContainer">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading scraping results...</p>
      </div>
    </div>
  </div>

  <script>
    let allData = [];
    let filteredData = [];
    let autoRefreshInterval = null;
    let isAutoRefresh = true;
    let currentViewMode = "grid";

    // Start auto-refresh immediately
    startAutoRefresh();

    async function loadDataFromAPI() {
      try {
        const response = await fetch("/api/data");
        const jsonData = await response.json();
        loadData(jsonData);
      } catch (error) {
        console.error("Error loading data from API:", error);
        setTimeout(loadDataFromAPI, 5000); // Retry after 5 seconds
      }
    }

    function loadData(jsonData) {
      allData = jsonData.data || [];
      filteredData = [...allData];

      updateStats(jsonData);
      displayResults(filteredData);
      updateScrapingStatus(jsonData.scraping_info?.status || "unknown");
    }

    function updateStats(jsonData) {
      const info = jsonData.scraping_info || {};

      document.getElementById("totalItems").textContent =
        info.total_items_found || info.items_found_so_far || allData.length;
      document.getElementById("totalPages").textContent =
        info.total_pages_processed || info.pages_processed_so_far || 0;
      document.getElementById("cpuCores").textContent =
        info.cpu_cores_used || 0;

      // Calculate average sources
      const totalSources = allData.reduce(
        (sum, item) => sum + (item.sources?.length || 0),
        0,
      );
      const avgSources =
        allData.length > 0 ? (totalSources / allData.length).toFixed(1) : 0;
      document.getElementById("avgSources").textContent = avgSources;

      // Update progress bar
      const progress =
        info.status === "completed"
          ? 100
          : info.status === "in_progress"
            ? Math.min(95, (info.pages_processed_so_far || 0) * 10)
            : 0;
      document.getElementById("progressFill").style.width = progress + "%";
    }

    function updateScrapingStatus(status) {
      const statusElement = document.getElementById("scrapingStatus");
      const indicatorElement = document.querySelector(
        "#statusIndicator .status-indicator",
      );

      if (status === "in_progress") {
        statusElement.textContent = "Scraping in progress...";
        indicatorElement.className = "status-indicator status-in-progress";
      } else if (status === "completed") {
        statusElement.textContent = "Scraping completed!";
        indicatorElement.className = "status-indicator status-completed";
      } else if (status === "initializing") {
        statusElement.textContent = "Initializing scraper...";
        indicatorElement.className = "status-indicator status-in-progress";
      } else {
        statusElement.textContent = "Status unknown";
        indicatorElement.className = "status-indicator status-completed";
      }
    }

    function displayResults(data) {
      const container = document.getElementById("resultsContainer");

      if (data.length === 0) {
        container.innerHTML = `
          <div class="loading">
            <p>No results found. Scraping may still be in progress...</p>
          </div>
        `;
        return;
      }

      const html = data
        .map((item) => {
          const sourcesHtml =
            item.sources && item.sources.length > 0
              ? item.sources
                .slice(0, 3)
                .map((source) => `<div class="source-item">${source}</div>`)
                .join("") +
              (item.sources.length > 3
                ? `<div class="source-item">... and ${item.sources.length - 3} more sources</div>`
                : "")
              : '<div class="no-sources">No video sources found</div>';

          const timestamp = new Date(item.timestamp * 1000).toLocaleString();
          const title = item.title || `Element ${item.element_index}`;
          const thumbnailHtml = item.thumbnail
            ? `<img src="${item.thumbnail}" alt="Thumbnail" class="thumbnail-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
            : "";

          return `
            <div class="result-card ${currentViewMode}-view" onclick="openLink('${item.url}')" data-url="${item.url}" data-title="${title.toLowerCase()}">
              <div class="card-thumbnail">
                ${thumbnailHtml}
                <div class="thumbnail-placeholder" style="${item.thumbnail ? "display: none;" : ""}">
                  🎬
                </div>
                <div class="card-overlay">
                  <div class="card-index">Page ${item.page} - #${item.element_index}</div>
                </div>
                <div class="card-sources-count">
                  📹 ${item.sources?.length || 0} sources
                </div>
                <div class="external-link-icon">🔗</div>
              </div>
              <div class="card-body">
                <div class="card-title">${title}</div>
                <div class="card-url">${item.url}</div>
                <div class="sources-list">
                  ${sourcesHtml}
                </div>
                <div class="timestamp">🕐 ${timestamp}</div>
              </div>
            </div>
          `;
        })
        .join("");

      container.innerHTML = `<div class="results-grid ${currentViewMode}-view">${html}</div>`;
    }

    function openLink(url) {
      window.open(url, "_blank");
    }

    function applyFilters() {
      const titleFilter = document
        .getElementById("titleFilter")
        .value.toLowerCase();
      const urlFilter = document
        .getElementById("urlFilter")
        .value.toLowerCase();
      const pageFilter = document.getElementById("pageFilter").value;
      const minSources = document.getElementById("minSources").value;

      filteredData = allData.filter((item) => {
        if (
          titleFilter &&
          !(item.title || "").toLowerCase().includes(titleFilter)
        )
          return false;
        if (urlFilter && !item.url.toLowerCase().includes(urlFilter))
          return false;
        if (pageFilter && item.page != pageFilter) return false;
        if (minSources && (item.sources?.length || 0) < parseInt(minSources))
          return false;
        return true;
      });

      displayResults(filteredData);
    }

    function clearFilters() {
      document.getElementById("titleFilter").value = "";
      document.getElementById("urlFilter").value = "";
      document.getElementById("pageFilter").value = "";
      document.getElementById("minSources").value = "";
      filteredData = [...allData];
      displayResults(filteredData);
    }

    function setViewMode(mode) {
      currentViewMode = mode;

      // Update buttons
      document.querySelectorAll(".view-mode-btn").forEach((btn) => {
        btn.classList.remove("active");
      });
      event.target.classList.add("active");

      displayResults(filteredData);
    }

    function toggleAutoRefresh() {
      const toggle = document.getElementById("autoRefreshToggle");
      const status = document.getElementById("refreshStatus");

      isAutoRefresh = !isAutoRefresh;

      if (isAutoRefresh) {
        toggle.classList.add("active");
        status.textContent = "ON";
        startAutoRefresh();
      } else {
        toggle.classList.remove("active");
        status.textContent = "OFF";
        stopAutoRefresh();
      }
    }

    function startAutoRefresh() {
      // Load data immediately
      loadDataFromAPI();

      // Set up interval for continuous updates
      autoRefreshInterval = setInterval(() => {
        loadDataFromAPI();
      }, 2000); // Refresh every 2 seconds
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
    }

    // Real-time search
    document
      .getElementById("titleFilter")
      .addEventListener("input", applyFilters);
    document
      .getElementById("urlFilter")
      .addEventListener("input", applyFilters);

    // Keyboard shortcuts
    document.addEventListener("keydown", function (e) {
      if (e.ctrlKey || e.metaKey) {
        if (e.key === "r") {
          e.preventDefault();
          toggleAutoRefresh();
        }
        if (e.key === "f") {
          e.preventDefault();
          document.getElementById("titleFilter").focus();
        }
      }
    });

    // Handle image load errors
    document.addEventListener(
      "error",
      function (e) {
        if (
          e.target.tagName === "IMG" &&
          e.target.classList.contains("thumbnail-image")
        ) {
          e.target.style.display = "none";
          const placeholder = e.target.nextElementSibling;
          if (
            placeholder &&
            placeholder.classList.contains("thumbnail-placeholder")
          ) {
            placeholder.style.display = "flex";
          }
        }
      },
      true,
    );
  </script>
</body>

</html>
